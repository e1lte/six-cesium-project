# é£è¡Œå™¨å¯è§†åŒ–ä»¿çœŸè½¯ä»¶ - æ€§èƒ½æŒ‡æ ‡åˆ†ææŠ¥å‘Š

## ğŸ“Š å½“å‰æ€§èƒ½æµ‹é‡ç»“æœ

### æ ¸å¿ƒç½‘é¡µæŒ‡æ ‡ (Core Web Vitals)

| æŒ‡æ ‡                   | å½“å‰å€¼    | ç›®æ ‡å€¼ | çŠ¶æ€ | è¯„çº§     |
| ---------------------- | --------- | ------ | ---- | -------- |
| **LCP** (æœ€å¤§å†…å®¹ç»˜åˆ¶) | 668ms     | <2.5s  | âœ…   | è‰¯å¥½     |
| **FID** (é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ) | æµ‹é‡ä¸­... | <100ms | â³   | å¾…æµ‹é‡   |
| **CLS** (ç´¯ç§¯å¸ƒå±€åç§») | 0.179     | <0.1   | âš ï¸   | éœ€è¦æ”¹è¿› |

### å…¶ä»–æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡                   | å½“å‰å€¼    | ç›®æ ‡å€¼ | çŠ¶æ€ | è¯„çº§   |
| ---------------------- | --------- | ------ | ---- | ------ |
| **FCP** (é¦–æ¬¡å†…å®¹ç»˜åˆ¶) | æµ‹é‡ä¸­... | <1.8s  | â³   | å¾…æµ‹é‡ |
| **TTI** (å¯äº¤äº’æ—¶é—´)   | 10324ms   | <5s    | âŒ   | å·®     |
| **TTFB** (é¦–å­—èŠ‚æ—¶é—´)  | 20ms      | <600ms | âœ…   | è‰¯å¥½   |
| **DOM å†…å®¹åŠ è½½**       | 205ms     | -      | âœ…   | è‰¯å¥½   |
| **é¡µé¢å®Œå…¨åŠ è½½**       | 328ms     | -      | âœ…   | è‰¯å¥½   |

---

## ğŸ” æ€§èƒ½æŒ‡æ ‡è¯¦ç»†è§£é‡Š

### 1. LCP (Largest Contentful Paint) - æœ€å¤§å†…å®¹ç»˜åˆ¶

**å«ä¹‰**: é¡µé¢ä¸»è¦å†…å®¹å®Œæˆæ¸²æŸ“çš„æ—¶é—´ï¼Œé€šå¸¸æ˜¯æœ€å¤§çš„æ–‡æœ¬å—æˆ–å›¾åƒå…ƒç´ ã€‚

**é¡¹ç›®ä¸­çš„æµ‹é‡å®ç°**:

```typescript
// src/utils/performanceOptimization.ts
private setupPerformanceObserver() {
    if ("PerformanceObserver" in window) {
        this.observer = new PerformanceObserver(list => {
            for (const entry of list.getEntries()) {
                if (entry.entryType === "largest-contentful-paint") {
                    this.metrics.lcp = entry.startTime;
                    console.log("ğŸ¯ LCP:", entry.startTime.toFixed(2), "ms");

                    // å¦‚æœLCPè¶…è¿‡2.5ç§’ï¼Œè®°å½•è­¦å‘Š
                    if (entry.startTime > 2500) {
                        console.warn("âš ï¸ LCPè¶…è¿‡2.5ç§’ï¼Œéœ€è¦ä¼˜åŒ–");
                        this.suggestLCPOptimizations();
                    }
                }
            }
        });

        // è§‚å¯Ÿå…³é”®æ€§èƒ½æŒ‡æ ‡
        this.observer.observe({
            entryTypes: ["largest-contentful-paint"]
        });
    }
}
```

**LCP ä¼˜åŒ–ç­–ç•¥**:

```typescript
// src/components/LCPOptimizer.tsx
const LCPOptimizer: React.FC<LCPOptimizerProps> = ({ children }) => {
    useEffect(() => {
        // é¢„åŠ è½½å…³é”®å­—ä½“
        const preloadFont = (
            fontUrl: string,
            fontFamily: string,
            weight: string
        ) => {
            const link = document.createElement("link");
            link.rel = "preload";
            link.as = "font";
            link.type = "font/woff2";
            link.crossOrigin = "anonymous";
            link.href = fontUrl;
            document.head.appendChild(link);

            // åˆ›å»ºå­—ä½“é¢
            const fontFace = new FontFace(fontFamily, `url(${fontUrl})`, {
                weight,
                style: "normal",
                display: "swap",
            });

            fontFace.load().then(loadedFace => {
                document.fonts.add(loadedFace);
                console.log(`âœ… å­—ä½“é¢„åŠ è½½å®Œæˆ: ${fontFamily} ${weight}`);
            });
        };

        // é¢„åŠ è½½å…³é”®å­—ä½“
        preloadFont(
            "https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2",
            "Inter",
            "400"
        );
    }, []);

    return <>{children}</>;
};
```

### 2. FID (First Input Delay) - é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ

**å«ä¹‰**: ç”¨æˆ·é¦–æ¬¡ä¸é¡µé¢äº¤äº’ï¼ˆç‚¹å‡»ã€è§¦æ‘¸ã€æŒ‰é”®ï¼‰åˆ°æµè§ˆå™¨å¼€å§‹å¤„ç†äº‹ä»¶çš„å»¶è¿Ÿæ—¶é—´ã€‚

**ä¸ºä»€ä¹ˆæ˜¾ç¤º"æµ‹é‡ä¸­"**: FID åªèƒ½åœ¨çœŸå®ç”¨æˆ·äº¤äº’æ—¶æµ‹é‡ï¼Œå®éªŒå®¤ç¯å¢ƒæ— æ³•æ¨¡æ‹Ÿã€‚

**é¡¹ç›®ä¸­çš„ç›¸å…³ä¼˜åŒ–**:

```typescript
// src/utils/performanceOptimization.ts
// ç›‘å¬é•¿ä»»åŠ¡ï¼Œé•¿ä»»åŠ¡ä¼šå½±å“FID
if (entry.entryType === "longtask") {
    this.longTaskCount++;
    console.warn("â±ï¸ æ£€æµ‹åˆ°é•¿ä»»åŠ¡:", entry.duration.toFixed(2), "ms");

    // é‡ç½®TTIæ£€æµ‹
    this.isInteractive = false;

    // å»¶è¿Ÿæ£€æŸ¥äº¤äº’æ€§
    setTimeout(() => this.checkInteractivity(), 100);
}
```

### 3. CLS (Cumulative Layout Shift) - ç´¯ç§¯å¸ƒå±€åç§» âš ï¸

**å«ä¹‰**: é¡µé¢åŠ è½½è¿‡ç¨‹ä¸­è§†è§‰å…ƒç´ æ„å¤–ç§»åŠ¨çš„ç´¯ç§¯åˆ†æ•°ã€‚

**å½“å‰é—®é¢˜**: 0.179 > 0.1 ç›®æ ‡å€¼ï¼Œéœ€è¦ä¼˜åŒ–

**é¡¹ç›®ä¸­çš„æµ‹é‡å®ç°**:

```typescript
// src/utils/performanceOptimization.ts
// ç›‘å¬å¸ƒå±€åç§»
if (entry.entryType === "layout-shift") {
    const layoutShiftEntry = entry as PerformanceEntry & {
        value: number;
        hadRecentInput: boolean;
    };
    if (!layoutShiftEntry.hadRecentInput) {
        this.metrics.cls = (this.metrics.cls || 0) + layoutShiftEntry.value;
        if (this.metrics.cls > 0.1) {
            console.warn("âš ï¸ CLSè¶…è¿‡0.1ï¼Œå¸ƒå±€ç¨³å®šæ€§éœ€è¦ä¼˜åŒ–");
        }
    }
}
```

**CLS ä¼˜åŒ–å»ºè®®**:

1. ä¸ºå›¾ç‰‡å’Œè§†é¢‘è®¾ç½®æ˜ç¡®çš„å®½é«˜å±æ€§
2. é¿å…åœ¨ç°æœ‰å†…å®¹ä¸Šæ–¹æ’å…¥å†…å®¹
3. ä½¿ç”¨`transform`åŠ¨ç”»è€Œä¸æ˜¯æ”¹å˜å¸ƒå±€å±æ€§
4. ä¸ºåŠ¨æ€å†…å®¹é¢„ç•™ç©ºé—´

### 4. FCP (First Contentful Paint) - é¦–æ¬¡å†…å®¹ç»˜åˆ¶

**å«ä¹‰**: é¡µé¢é¦–æ¬¡æ¸²æŸ“ä»»ä½•å†…å®¹çš„æ—¶é—´ã€‚

**é¡¹ç›®ä¸­çš„æµ‹é‡å®ç°**:

```typescript
if (entry.entryType === "first-contentful-paint") {
    this.metrics.fcp = entry.startTime;
    console.log("ğŸ¨ FCP:", entry.startTime.toFixed(2), "ms");
}
```

### 5. TTI (Time to Interactive) - å¯äº¤äº’æ—¶é—´ âŒ

**å«ä¹‰**: é¡µé¢å®Œå…¨å¯äº¤äº’çš„æ—¶é—´ã€‚

**å½“å‰é—®é¢˜**: 10324ms >> 5000ms ç›®æ ‡å€¼ï¼Œä¸»è¦ç”±äº Cesium é‡å‹ 3D åº“

**é¡¹ç›®ä¸­çš„æµ‹é‡å®ç°**:

```typescript
// src/utils/performanceOptimization.ts
private checkInteractivity() {
    if (this.isInteractive) return;

    const now = performance.now();

    // ç®€åŒ–çš„TTIæ£€æµ‹ï¼šDOMåŠ è½½å®Œæˆ + æ²¡æœ‰é•¿ä»»åŠ¡ + ä¸»è¦èµ„æºåŠ è½½å®Œæˆ
    if (document.readyState === "complete" && this.longTaskCount === 0) {
        this.isInteractive = true;
        this.metrics.tti = now;
        console.log("ğŸ¯ TTI:", this.metrics.tti.toFixed(2), "ms");

        // TTIè¶…è¿‡5ç§’å‘å‡ºè­¦å‘Š
        if (this.metrics.tti > 5000) {
            console.warn("âš ï¸ TTIè¶…è¿‡5ç§’ï¼Œé¡µé¢äº¤äº’æ€§èƒ½éœ€è¦ä¼˜åŒ–");
            this.suggestTTIOptimizations();
        }
    }
}

// TTIä¼˜åŒ–å»ºè®®
private suggestTTIOptimizations() {
    console.group("ğŸ”§ TTIä¼˜åŒ–å»ºè®®:");
    console.log("1. å‡å°‘JavaScriptåŒ…å¤§å°");
    console.log("2. ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½");
    console.log("3. ç§»é™¤æœªä½¿ç”¨çš„ä»£ç ");
    console.log("4. ä¼˜åŒ–ç¬¬ä¸‰æ–¹è„šæœ¬åŠ è½½");
    console.log("5. ä½¿ç”¨Web Workerså¤„ç†é‡è®¡ç®—");
    console.log("6. å‡å°‘ä¸»çº¿ç¨‹é˜»å¡æ—¶é—´");
    console.groupEnd();
}
```

### 6. TTFB (Time to First Byte) - é¦–å­—èŠ‚æ—¶é—´ âœ…

**å«ä¹‰**: ä»è¯·æ±‚å¼€å§‹åˆ°æ¥æ”¶åˆ°ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ—¶é—´ã€‚

**é¡¹ç›®ä¸­çš„æµ‹é‡å®ç°**:

```typescript
if (entry.entryType === "navigation") {
    const navEntry = entry as PerformanceNavigationTiming;
    this.metrics.ttfb = navEntry.responseStart - navEntry.requestStart;
    this.metrics.domContentLoaded =
        navEntry.domContentLoadedEventEnd - navEntry.fetchStart;
    this.metrics.loadComplete = navEntry.loadEventEnd - navEntry.fetchStart;

    console.log("ğŸŒ TTFB:", this.metrics.ttfb.toFixed(2), "ms");
    console.log(
        "ğŸ“„ DOM Content Loaded:",
        this.metrics.domContentLoaded.toFixed(2),
        "ms"
    );
    console.log(
        "âœ… Load Complete:",
        this.metrics.loadComplete.toFixed(2),
        "ms"
    );
}
```

---

## ğŸ› ï¸ é¡¹ç›®ä¸­çš„æ€§èƒ½ä¼˜åŒ–å®ç°

### 1. æ€§èƒ½ç›‘æ§ç³»ç»Ÿ

**æ ¸å¿ƒç±»**: `PerformanceOptimizer`

```typescript
// src/utils/performanceOptimization.ts
export class PerformanceOptimizer {
    private static instance: PerformanceOptimizer;
    private preloadedModules = new Map<string, unknown>();
    private metrics: Partial<PerformanceMetrics> = {};
    private observer: PerformanceObserver | null = null;
    private ttiStartTime: number = 0;
    private isInteractive: boolean = false;
    private longTaskCount: number = 0;
    private measurementTimeout: NodeJS.Timeout | null = null;

    static getInstance(): PerformanceOptimizer {
        if (!PerformanceOptimizer.instance) {
            PerformanceOptimizer.instance = new PerformanceOptimizer();
        }
        return PerformanceOptimizer.instance;
    }

    // åˆå§‹åŒ–æ‰€æœ‰ä¼˜åŒ–
    init() {
        this.setupPerformanceObserver();
        this.optimizeImages();
        this.preloadCriticalModules();
        this.preloadUserInteractionModules();
        this.optimizeFonts();
        this.setupIntersectionObserver();
        this.optimizeCesiumLoading();
        this.setupResourceHints();
    }
}
```

### 2. æ¨¡å—é¢„åŠ è½½ç­–ç•¥

**å…³é”®æ¨¡å—é¢„åŠ è½½**:

```typescript
// é¢„åŠ è½½å…³é”®æ¨¡å—
async preloadCriticalModules() {
    const criticalModules = [
        () => import("../view/FirstPage.tsx"),
        () => import("../components/LoadingSpinner.tsx"),
    ];

    const promises = criticalModules.map(async (moduleLoader, index) => {
        try {
            const module = await moduleLoader();
            this.preloadedModules.set(`critical-${index}`, module);
            console.log(`âœ… é¢„åŠ è½½å…³é”®æ¨¡å— ${index + 1}`);
        } catch (error) {
            console.warn(`âŒ é¢„åŠ è½½å…³é”®æ¨¡å— ${index + 1} å¤±è´¥:`, error);
        }
    });

    await Promise.all(promises);
}

// é¢„åŠ è½½ç”¨æˆ·å¯èƒ½äº¤äº’çš„æ¨¡å—
async preloadUserInteractionModules() {
    // å»¶è¿Ÿé¢„åŠ è½½ï¼Œé¿å…é˜»å¡å…³é”®æ¸²æŸ“è·¯å¾„
    setTimeout(async () => {
        const interactionModules = [
            () => import("../view/ModelSelectionModal.tsx"),
            () => import("../view/RealTimeSimulationModal.tsx"),
        ];

        for (const moduleLoader of interactionModules) {
            try {
                const module = await moduleLoader();
                this.preloadedModules.set(moduleLoader.toString(), module);
                console.log("âœ… é¢„åŠ è½½äº¤äº’æ¨¡å—");
            } catch (error) {
                console.warn("âŒ é¢„åŠ è½½äº¤äº’æ¨¡å—å¤±è´¥:", error);
            }
        }
    }, 2000); // 2ç§’åå¼€å§‹é¢„åŠ è½½
}
```

### 3. å›¾ç‰‡ä¼˜åŒ–

**æ‡’åŠ è½½å®ç°**:

```typescript
private optimizeImages() {
    // å»¶è¿ŸåŠ è½½å›¾ç‰‡
    const images = document.querySelectorAll("img[data-src]");
    const imageObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target as HTMLImageElement;
                img.src = img.dataset.src || "";
                img.removeAttribute("data-src");
                imageObserver.unobserve(img);
            }
        });
    });

    images.forEach(img => imageObserver.observe(img));
}
```

### 4. å­—ä½“ä¼˜åŒ–

**å­—ä½“é¢„åŠ è½½å’Œä¼˜åŒ–**:

```typescript
private optimizeFonts() {
    // ä¼˜åŒ–å­—ä½“åŠ è½½
    if ("fonts" in document) {
        // é¢„åŠ è½½å…³é”®å­—ä½“
        const fontFaces = [
            new FontFace(
                "Inter",
                "url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2)",
                {
                    weight: "400",
                    style: "normal",
                    display: "swap",
                }
            ),
            new FontFace(
                "Inter",
                "url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYAZ9hiA.woff2)",
                {
                    weight: "600",
                    style: "normal",
                    display: "swap",
                }
            ),
        ];

        fontFaces.forEach(fontFace => {
            fontFace.load().then(loadedFace => {
                document.fonts.add(loadedFace);
            }).catch(err => {
                console.warn("å­—ä½“åŠ è½½å¤±è´¥:", err);
            });
        });
    }
}
```

### 5. Cesium ä¼˜åŒ–åŠ è½½

**ç°ä»£åŒ–åŠ è½½ç•Œé¢**:

```typescript
private optimizeCesiumLoading() {
    // ä¼˜åŒ–CesiumåŠ è½½
    const cesiumContainer = document.querySelector("#cesium-container");
    if (cesiumContainer) {
        // ä¸ºCesiumå®¹å™¨æ·»åŠ ç°ä»£åŒ–å ä½ç¬¦
        cesiumContainer.innerHTML = `
            <div style="
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: white;
                font-family: 'Inter', 'Microsoft YaHei', sans-serif;
                position: relative;
                overflow: hidden;
            ">
                <!-- èƒŒæ™¯åŠ¨ç”»ç²’å­ -->
                <div style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-image:
                        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.1), transparent),
                        radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.05), transparent);
                    background-repeat: repeat;
                    background-size: 200px 100px;
                    animation: stars 20s linear infinite;
                    opacity: 0.6;
                "></div>

                <!-- åœ°çƒå›¾æ ‡å’ŒåŠ è½½å†…å®¹ -->
                <div style="position: relative; z-index: 2; text-align: center;">
                    <div style="
                        width: 80px;
                        height: 80px;
                        margin: 0 auto 30px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                        animation: earthRotate 4s linear infinite;
                    "></div>
                    <h2>é£è¡Œå™¨å¯è§†åŒ–ä»¿çœŸè½¯ä»¶</h2>
                    <p>æ­£åœ¨åˆå§‹åŒ–ä¸‰ç»´åœ°çƒç¯å¢ƒ...</p>
                </div>
            </div>
        `;
    }
}
```

### 6. èµ„æºæç¤ºä¼˜åŒ–

**DNS é¢„è§£æå’Œé¢„è¿æ¥**:

```typescript
private setupResourceHints() {
    // æ·»åŠ èµ„æºæç¤º
    const hints = [
        { rel: "dns-prefetch", href: "//fonts.googleapis.com" },
        { rel: "dns-prefetch", href: "//fonts.gstatic.com" },
        { rel: "preconnect", href: "https://fonts.googleapis.com" },
        { rel: "preconnect", href: "https://fonts.gstatic.com", crossorigin: true },
    ];

    hints.forEach(hint => {
        const link = document.createElement("link");
        link.rel = hint.rel;
        link.href = hint.href;
        if (hint.crossorigin) {
            link.crossOrigin = "anonymous";
        }
        document.head.appendChild(link);
    });
}
```

### 7. æ€§èƒ½ç›‘æ§é¢æ¿

**å®æ—¶æ€§èƒ½ç›‘æ§ UI**:

```typescript
// src/components/PerformanceDashboard.tsx
const PerformanceDashboard: React.FC<PerformanceDashboardProps> = ({
    isVisible,
    onToggle,
}) => {
    const [metrics, setMetrics] = useState<PerformanceMetrics>({});
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        if (!isVisible) return;

        // åˆå§‹è·å–æŒ‡æ ‡
        const updateMetrics = () => {
            const currentMetrics = performanceOptimizer.getMetrics();
            setMetrics(currentMetrics);

            // å¦‚æœTTIå·²ç»æµ‹é‡å®Œæˆï¼Œåœæ­¢åŠ è½½çŠ¶æ€
            if (currentMetrics.tti !== undefined) {
                setIsLoading(false);
            }
        };

        updateMetrics();

        // å®šæœŸæ›´æ–°æŒ‡æ ‡
        const interval = setInterval(updateMetrics, 1000);

        // è®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´
        const timeout = setTimeout(() => {
            setIsLoading(false);
        }, 12000); // 12ç§’åå¼ºåˆ¶åœæ­¢åŠ è½½

        return () => {
            clearInterval(interval);
            clearTimeout(timeout);
        };
    }, [isVisible]);

    const formatMetric = (value?: number, unit = "ms") => {
        if (value === undefined) return "æµ‹é‡ä¸­...";
        return `${Math.round(value)}${unit}`;
    };

    const getScoreColor = (
        value: number,
        thresholds: { good: number; poor: number }
    ) => {
        if (value <= thresholds.good) return "#0cce6b";
        if (value <= thresholds.poor) return "#ffa400";
        return "#ff4e42";
    };

    const getScoreLabel = (
        value: number,
        thresholds: { good: number; poor: number }
    ) => {
        if (value <= thresholds.good) return "è‰¯å¥½";
        if (value <= thresholds.poor) return "éœ€è¦æ”¹è¿›";
        return "å·®";
    };

    return (
        <div className="performance-dashboard">
            <div className="dashboard-header">
                <h3>æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿</h3>
                <button className="close-btn" onClick={onToggle}>
                    Ã—
                </button>
            </div>

            {isLoading && (
                <div className="loading-indicator">
                    <div className="spinner"></div>
                    <span>æ­£åœ¨æµ‹é‡æ€§èƒ½æŒ‡æ ‡...</span>
                </div>
            )}

            <div className="metrics-grid">
                {/* Core Web Vitals */}
                <div className="metric-section">
                    <h4>æ ¸å¿ƒç½‘é¡µæŒ‡æ ‡ (Core Web Vitals)</h4>

                    <div className="metric-item">
                        <div className="metric-label">
                            <span>LCP (æœ€å¤§å†…å®¹ç»˜åˆ¶)</span>
                            <span className="metric-info">ç›®æ ‡: &lt;2.5s</span>
                        </div>
                        <div className="metric-value">
                            <span
                                style={{
                                    color: metrics.lcp
                                        ? getScoreColor(metrics.lcp, {
                                              good: 2500,
                                              poor: 4000,
                                          })
                                        : "#666",
                                }}
                            >
                                {formatMetric(metrics.lcp)}
                            </span>
                            {metrics.lcp && (
                                <span className="metric-score">
                                    {getScoreLabel(metrics.lcp, {
                                        good: 2500,
                                        poor: 4000,
                                    })}
                                </span>
                            )}
                        </div>
                    </div>

                    {/* å…¶ä»–æŒ‡æ ‡... */}
                </div>
            </div>
        </div>
    );
};
```

### 8. æ„å»ºä¼˜åŒ–é…ç½®

**Vite æ„å»ºä¼˜åŒ–**:

```typescript
// vite.config.ts
export default defineConfig({
    build: {
        rollupOptions: {
            output: {
                manualChunks: {
                    // å°†Cesiumå•ç‹¬æ‰“åŒ…
                    cesium: ["cesium"],
                    // Reactç›¸å…³åº“æ‰“åŒ…
                    "react-core": ["react", "react-dom"],
                    // å·¥å…·åº“æ‰“åŒ…
                    utils: ["lodash", "dayjs"],
                },

                // ä¼˜åŒ–æ–‡ä»¶åå’Œåˆ†åŒ…
                chunkFileNames: chunkInfo => {
                    if (chunkInfo.name === "cesium") {
                        return "js/cesium-[hash].js";
                    }
                    if (chunkInfo.name === "react-core") {
                        return "js/react-[hash].js";
                    }
                    return "js/[name]-[hash].js";
                },
                entryFileNames: "js/main-[hash].js",
                assetFileNames: assetInfo => {
                    if (!assetInfo.name) {
                        return "assets/[name]-[hash][extname]";
                    }

                    const info = assetInfo.name.split(".");
                    const ext = info[info.length - 1];

                    if (
                        /\.(png|jpe?g|gif|svg|ico|webp)(\?.*)?$/i.test(
                            assetInfo.name
                        )
                    ) {
                        return `img/[name]-[hash].${ext}`;
                    }
                    if (ext === "css") {
                        return `css/[name]-[hash].${ext}`;
                    }
                    if (
                        /\.(woff|woff2|eot|ttf|otf)(\?.*)?$/i.test(
                            assetInfo.name
                        )
                    ) {
                        return `fonts/[name]-[hash].${ext}`;
                    }
                    return `assets/[name]-[hash].${ext}`;
                },
            },
        },

        chunkSizeWarningLimit: 2000, // é™ä½åˆ°2MB
        cssCodeSplit: true, // å¯ç”¨CSSä»£ç åˆ†å‰²
        assetsInlineLimit: 4096, // 4KBä»¥ä¸‹çš„èµ„æºå†…è”
    },

    // ä¼˜åŒ–ä¾èµ–é¢„æ„å»º
    optimizeDeps: {
        include: ["react", "react-dom", "cesium"],
        exclude: [],
    },
});
```

### 9. HTML é¢„åŠ è½½ä¼˜åŒ–

**å…³é”®èµ„æºé¢„åŠ è½½**:

```html
<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
        <link rel="preload" href="/src/main.tsx" as="script" crossorigin />
        <link
            rel="preload"
            href="/src/view/FirstPage.tsx"
            as="script"
            crossorigin
        />

        <!-- é¢„è¿æ¥åˆ°å¤–éƒ¨èµ„æº -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <!-- é¢„åŠ è½½å…³é”®å­—ä½“ -->
        <link
            rel="preload"
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            as="style"
            onload="this.onload=null;this.rel='stylesheet'"
        />
    </head>
    <body>
        <!-- é¡µé¢å†…å®¹ -->
    </body>
</html>
```

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®ä¸è¡ŒåŠ¨è®¡åˆ’

### ğŸ”´ é«˜ä¼˜å…ˆçº§ - CLS ä¼˜åŒ– (0.179 â†’ <0.1)

1. **å›¾ç‰‡å°ºå¯¸å›ºå®š**

    - ä¸ºæ‰€æœ‰å›¾ç‰‡æ·»åŠ æ˜ç¡®çš„`width`å’Œ`height`å±æ€§
    - ä½¿ç”¨`aspect-ratio` CSS å±æ€§

2. **å­—ä½“åŠ è½½ä¼˜åŒ–**

    - ä½¿ç”¨`font-display: swap`
    - é¢„åŠ è½½å…³é”®å­—ä½“æ–‡ä»¶

3. **åŠ¨æ€å†…å®¹ä¼˜åŒ–**
    - ä¸ºåŠ¨æ€åŠ è½½çš„å†…å®¹é¢„ç•™ç©ºé—´
    - ä½¿ç”¨éª¨æ¶å±å ä½

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ - TTI ä¼˜åŒ– (10324ms â†’ <5000ms)

1. **ä»£ç åˆ†å‰²**

    - å°† Cesium åº“è¿›è¡Œæ‡’åŠ è½½
    - æŒ‰è·¯ç”±åˆ†å‰²ä»£ç 

2. **å‡å°‘ä¸»çº¿ç¨‹é˜»å¡**

    - ä½¿ç”¨ Web Workers å¤„ç†é‡è®¡ç®—
    - ä¼˜åŒ– JavaScript æ‰§è¡Œæ—¶é—´

3. **èµ„æºä¼˜åŒ–**
    - å‹ç¼© JavaScript å’Œ CSS
    - ç§»é™¤æœªä½¿ç”¨çš„ä»£ç 

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ - æŒç»­ç›‘æ§

1. **ä¿æŒç°æœ‰ä¼˜åŠ¿**

    - ç»´æŒä¼˜ç§€çš„ TTFB (20ms)
    - ä¿æŒè‰¯å¥½çš„ LCP (668ms)

2. **ç›‘æ§ FCP å’Œ FID**
    - ç­‰å¾…çœŸå®ç”¨æˆ·æ•°æ®
    - æŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§é¢æ¿æ ·å¼

```css
/* src/components/PerformanceDashboard.css */
.performance-dashboard {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 400px;
    max-height: 80vh;
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid #333;
    border-radius: 8px;
    color: white;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    z-index: 10000;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease-out;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #333;
    background: rgba(0, 0, 0, 0.8);
}

.loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    gap: 10px;
    color: #ccc;
}

.spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #333;
    border-top: 2px solid #0cce6b;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.metric-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}
```

---

## ğŸ”§ åˆå§‹åŒ–å’Œä½¿ç”¨

**åœ¨åº”ç”¨å…¥å£åˆå§‹åŒ–æ€§èƒ½ç›‘æ§**:

```typescript
// src/main.tsx
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import "./index.css";
import App from "./App.tsx";
import { performanceOptimizer } from "./utils/performanceOptimization";

// åˆå§‹åŒ–æ€§èƒ½ä¼˜åŒ–
performanceOptimizer.init();

createRoot(document.getElementById("root")!).render(
    <StrictMode>
        <App />
    </StrictMode>
);
```

**åœ¨ç»„ä»¶ä¸­ä½¿ç”¨æ€§èƒ½ç›‘æ§**:

```typescript
// src/view/FirstPage.tsx
import { performanceOptimizer } from "../utils/performanceOptimization";
import LCPOptimizer from "../components/LCPOptimizer";
import PerformanceDashboard from "../components/PerformanceDashboard";

function FirstPage() {
    const [showPerformanceDashboard, setShowPerformanceDashboard] =
        useState(false);

    return (
        <LCPOptimizer>
            <div className="first-page">
                {/* é¡µé¢å†…å®¹ */}

                {/* æ€§èƒ½ç›‘æ§é¢æ¿ */}
                <PerformanceDashboard
                    isVisible={showPerformanceDashboard}
                    onToggle={() =>
                        setShowPerformanceDashboard(!showPerformanceDashboard)
                    }
                />
            </div>
        </LCPOptimizer>
    );
}
```

---

## ğŸ“Š æ€»ç»“

æ‚¨çš„é£è¡Œå™¨å¯è§†åŒ–ä»¿çœŸè½¯ä»¶åœ¨æŸäº›æ€§èƒ½æŒ‡æ ‡ä¸Šè¡¨ç°ä¼˜ç§€ï¼š

-   **TTFB (20ms)**: æœåŠ¡å™¨å“åº”æå¿«
-   **LCP (668ms)**: ä¸»è¦å†…å®¹åŠ è½½è¿…é€Ÿ
-   **DOM åŠ è½½ (205ms)**: HTML è§£æé«˜æ•ˆ

éœ€è¦é‡ç‚¹å…³æ³¨çš„é—®é¢˜ï¼š

-   **CLS (0.179)**: å¸ƒå±€ç¨³å®šæ€§éœ€è¦æ”¹è¿›
-   **TTI (10324ms)**: äº¤äº’æ€§èƒ½éœ€è¦å¤§å¹…ä¼˜åŒ–

é€šè¿‡å®æ–½ä¸Šè¿°ä¼˜åŒ–ç­–ç•¥ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ CLS å’Œ TTI çš„æ”¹è¿›ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒå’Œæ€§èƒ½è¯„åˆ†ã€‚é¡¹ç›®ä¸­å·²ç»å»ºç«‹äº†å®Œå–„çš„æ€§èƒ½ç›‘æ§ä½“ç³»ï¼Œä¸ºæŒç»­ä¼˜åŒ–æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚
