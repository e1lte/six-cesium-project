# 轨迹仿真 WebSocket 服务器

这是一个 Node.js WebSocket 服务器，用于为 Cesium 前端应用提供实时的六自由度轨迹数据。

## 功能特性

-   🚀 实时生成两个模型的轨迹数据
-   📍 六自由度数据：经度、纬度、高度、偏航角、俯仰角、滚转角
-   🔄 10Hz 更新频率（每 100ms 发送一次数据）
-   🌐 WebSocket 实时通信
-   📊 两种不同的轨迹模式：
    -   **模型 1**: 圆形轨迹（北京地区）
    -   **模型 2**: 8 字形轨迹（北京地区）

## 轨迹说明

### 模型 1 - 圆形轨迹

-   **中心位置**: 北京 (116.4°E, 39.9°N)
-   **轨迹半径**: 0.01 度 (约 1.1 公里)
-   **基础高度**: 500 米
-   **运动特点**:
    -   圆形水平运动
    -   高度随角度变化 (±50 米)
    -   连续偏航旋转
    -   周期性俯仰和滚转

### 模型 2 - 8 字形轨迹

-   **中心位置**: 北京 (116.4°E, 40.0°N)
-   **轨迹范围**: X 方向 1.5km, Y 方向 0.9km
-   **基础高度**: 600 米
-   **运动特点**:
    -   8 字形（利萨如曲线）水平运动
    -   高度随角度变化 (±80 米)
    -   反向偏航旋转
    -   不同频率的俯仰和滚转

## 安装和运行

### 1. 确保依赖已安装

```bash
# 在项目根目录运行
npm install
```

### 2. 启动服务器

```bash
# 方法1: 直接运行
node server/trajectory_server.js

# 方法2: 使用启动脚本（推荐）
node server/start_trajectory_server.js
```

### 3. 服务器信息

-   **监听端口**: 8080
-   **WebSocket 地址**: `ws://localhost:8080`
-   **更新频率**: 10Hz (每 100ms)

## 数据格式

服务器发送的 JSON 数据格式：

```json
{
    "timestamp": 1703123456789,
    "model1": {
        "longitude": 116.404523,
        "latitude": 39.902341,
        "altitude": 525.6,
        "yaw": 45.2,
        "pitch": 8.7,
        "roll": -3.1
    },
    "model2": {
        "longitude": 116.398765,
        "latitude": 40.001234,
        "altitude": 642.3,
        "yaw": -23.8,
        "pitch": 12.4,
        "roll": 5.9
    }
}
```

### 字段说明

-   `timestamp`: 时间戳（毫秒）
-   `longitude`: 经度（度）
-   `latitude`: 纬度（度）
-   `altitude`: 高度（米）
-   `yaw`: 偏航角（度，0-360）
-   `pitch`: 俯仰角（度，-90 到 90）
-   `roll`: 滚转角（度，-180 到 180）

## 客户端消息

客户端可以发送以下消息来控制服务器：

```json
// 开始仿真
{"type": "start_simulation"}

// 停止仿真
{"type": "stop_simulation"}

// 获取状态
{"type": "get_status"}
```

## 服务器响应

服务器会发送以下类型的消息：

```json
// 欢迎消息
{
  "type": "welcome",
  "message": "已连接到轨迹仿真服务器",
  "isSimulationRunning": false,
  "updateInterval": 100
}

// 状态响应
{
  "type": "status",
  "isSimulationRunning": true,
  "clientCount": 2
}

// 服务器关闭通知
{
  "type": "server_shutdown",
  "message": "服务器即将关闭"
}
```

## 前端集成

在前端代码中，确保 WebSocket 连接地址设置为：

```javascript
const ws = new WebSocket("ws://localhost:8080");
```

服务器会自动在有客户端连接时开始仿真，在所有客户端断开时停止仿真。

## 调试和监控

服务器会输出详细的日志信息：

-   客户端连接/断开状态
-   仿真开始/停止状态
-   定期的位置数据（10%采样率）
-   错误信息

## 注意事项

1. **端口冲突**: 确保 8080 端口未被其他应用占用
2. **Node.js 版本**: 需要 Node.js 14.0.0 或更高版本
3. **内存使用**: 长时间运行时内存使用稳定
4. **网络延迟**: 本地运行延迟极低，适合实时仿真

## 故障排除

### 常见问题

1. **端口被占用**

    ```
    Error: listen EADDRINUSE :::8080
    ```

    解决方案：更改服务器端口或关闭占用 8080 端口的程序

2. **模块未找到**

    ```
    Error: Cannot find module 'ws'
    ```

    解决方案：运行 `npm install ws`

3. **前端连接失败**
    - 确保服务器正在运行
    - 检查防火墙设置
    - 确认 WebSocket 地址正确

## 扩展功能

可以通过修改 `trajectoryParams` 对象来自定义轨迹：

-   调整轨迹形状和大小
-   修改运动速度
-   改变姿态变化模式
-   添加更多模型

## 性能优化

-   使用高效的数学计算
-   智能的日志输出（采样）
-   自动的客户端管理
-   优雅的错误处理
